# VxWorks

!!! note "引言"
    VxWorks是全球安全认证等级最高的商用实时操作系统之一，广泛应用于航空航天、国防军工、轨道交通、工业自动化和医疗设备等对可靠性要求极高的领域。从NASA的火星探测车到波音787客机的航电系统，VxWorks在众多关键任务系统中发挥着核心作用。

VxWorks操作系统是美国WindRiver公司于1983年设计开发的一种嵌入式实时操作系统（RTOS），是Tornado嵌入式开发环境的关键组成部分。良好的持续发展能力、高性能的内核以及友好的用户开发环境，在嵌人式实时操作系统领域逐渐占据一席之地。

VxWorks具有可裁剪微内核结构；高效的任务管理；灵活的任务间通讯；微秒级的中断处理；支持POSIX 1003．1b实时扩展标准；支持多种物理介质及标准的、完整的TCP/IP网络协议等。然而其价格昂贵。由于操作系统本身以及开发环境都是专有的，价格一般都比较高，通常需花费10万元人民币以上才能建起一个可用的开发环境，对每一个应用一般还要另外收取版税。一般不通供源代码，只提供二进制代码。由于它们都是专用操作系统，需要专门的技术人员掌握开发技术和维护，所以软件的开发和维护成本都非常高。支持的硬件数量有限。


## Wind微内核架构

VxWorks的核心是Wind微内核（Wind Microkernel），这是一个高度优化的实时内核，具有以下架构特点：

- **微内核设计**：内核仅包含最基本的功能，如任务调度、中断处理、任务间通信和同步机制。文件系统、网络协议栈等扩展功能以可选组件的形式提供。
- **可裁剪性（Scalability）**：Wind内核支持高度裁剪，开发者可以根据目标系统的需求选择性地包含或排除功能组件。最小配置下，VxWorks的ROM占用可以控制在数百KB级别。
- **确定性调度**：Wind内核提供微秒级的中断响应时间和确定性的任务切换时间，满足硬实时应用的需求。

VxWorks的系统架构从底层到顶层依次为：

1. **板级支持包（Board Support Package, BSP）**：封装与具体硬件板卡相关的初始化代码和驱动程序。
2. **Wind微内核**：实现核心的调度、同步和通信功能。
3. **系统组件**：包括文件系统、网络协议栈、设备驱动框架等。
4. **应用程序**：运行在内核之上的用户应用。


## 任务管理

VxWorks的任务管理机制是其实时性能的基础。

### 任务调度

VxWorks采用基于优先级的抢占式调度算法，支持256个优先级等级（0为最高优先级，255为最低优先级）。调度器始终运行优先级最高的就绪任务。在同一优先级内，可选择时间片轮转（Round-Robin）调度。

### 任务状态

VxWorks中的任务状态包括：

- **就绪态（Ready）**：任务等待处理器资源。
- **挂起态（Pended）**：任务等待某个资源（如信号量、消息队列）。
- **延时态（Delayed）**：任务在等待一个定时器到期。
- **挂起+延时态（Pended + Delayed）**：任务同时等待资源和定时器。
- **暂停态（Suspended）**：任务被显式暂停，通常用于调试。

### 任务间通信

VxWorks提供了丰富的任务间通信（Inter-Task Communication, ITC）机制：

- **信号量（Semaphore）**：支持二值信号量、计数信号量和互斥信号量。互斥信号量内置优先级继承机制。
- **消息队列（Message Queue）**：支持变长消息的FIFO传递，可选择紧急消息插入队列头部。
- **管道（Pipe）**：基于虚拟I/O设备的任务间通信方式，兼容标准的read/write接口。
- **共享内存（Shared Memory）**：多处理器系统中的通信方式。
- **信号（Signal）**：类UNIX的异步通知机制。


## 内存保护

VxWorks在内存管理方面提供了多层次的保护机制：

- **实时进程模型（Real-Time Process, RTP）**：VxWorks 6.0引入的用户态进程模型，每个RTP拥有独立的地址空间，通过MMU实现内存隔离。一个RTP的崩溃不会影响内核和其他RTP。
- **内核任务模式**：传统的VxWorks任务运行在内核态，所有任务共享同一地址空间，效率最高但缺少隔离保护。
- **内存分区保护**：内核可以为不同的任务组分配独立的内存分区，防止越界访问。
- **栈溢出检测**：内核可以在任务栈的边界设置保护页（Guard Page），检测栈溢出错误。


## 网络协议栈

VxWorks内置了完整的网络协议栈，支持：

- **TCP/IP协议族**：包括IPv4、IPv6、TCP、UDP、ICMP、ARP等核心协议。
- **路由协议**：RIP、OSPF等。
- **应用层协议**：HTTP、FTP、TFTP、SNMP、SSH、DNS等。
- **网络安全**：IPsec、SSL/TLS、防火墙等。
- **工业协议**：支持EtherNet/IP、PROFINET等工业以太网协议。
- **高可用性**：VRRP（虚拟路由冗余协议）和快速故障切换。


## 开发工具

### Tornado开发环境

Tornado是VxWorks早期版本的集成开发环境（IDE），包括：

- **编译器和构建工具**：基于GNU工具链的交叉编译环境。
- **目标服务器（Target Server）**：连接主机开发环境和目标板的桥梁，支持通过以太网、串口等方式与目标板通信。
- **Shell**：交互式命令行工具，可在运行的VxWorks系统上直接调用函数和查看系统状态。
- **调试器（CrossWind）**：支持源码级调试、断点设置、单步执行等功能。

### Wind River Workbench

Wind River Workbench是基于Eclipse的新一代IDE，取代了Tornado，提供了更现代化的开发体验：

- 图形化的项目管理和构建配置
- 集成的系统查看器（System Viewer），可实时查看任务调度、中断和事件
- 代码分析和性能优化工具
- 支持VxWorks和Wind River Linux的统一开发
- 集成版本控制和团队协作功能


## 安全认证

VxWorks是获得安全认证最多的商用RTOS之一，这使其成为安全关键系统的首选：

| 认证标准 | 适用领域 | 等级 |
|----------|----------|------|
| DO-178C | 航空航天 | DAL A（最高等级） |
| IEC 61508 | 工业安全 | SIL 3 |
| ISO 26262 | 汽车电子 | ASIL D |
| IEC 62304 | 医疗设备 | Class C |
| EN 50128 | 轨道交通 | SIL 4 |

Wind River提供的安全认证版本称为**VxWorks Cert**，该版本在标准VxWorks基础上经过严格的代码审查、测试和文档化流程，满足各行业的安全认证要求。


## 知名应用案例

VxWorks在全球众多关键系统中得到应用，以下是一些著名案例：

- **NASA火星探测**：火星探路者号（Mars Pathfinder, 1997）、勇气号（Spirit）和机遇号（Opportunity）火星车、好奇号（Curiosity）火星车均运行VxWorks。火星探路者号在着陆后曾遭遇优先级反转（Priority Inversion）导致的系统重启问题，最终通过远程启用优先级继承机制解决。
- **波音787梦想客机**：航电系统中的多个关键子系统运行VxWorks，负责飞行控制和机载系统管理。
- **SpaceX**：Dragon飞船的部分航电系统使用VxWorks。
- **轨道交通**：全球众多高速铁路和地铁的列车控制系统采用VxWorks。
- **网络设备**：众多企业级路由器和交换机的控制平面运行VxWorks。


## VxWorks 7

VxWorks 7是Wind River于2014年发布的最新一代VxWorks平台，引入了多项重要更新：

- **模块化架构**：采用分层的模块化设计，内核、中间件和应用层可以独立更新和部署。
- **容器支持**：支持在VxWorks上运行OCI兼容的容器，便于部署和管理应用。
- **安全增强**：内置安全启动（Secure Boot）、安全存储和加密框架。
- **多核支持优化**：改进了对称多处理（SMP）和非对称多处理（AMP）的支持。
- **开发者体验**：支持C++14/17标准，改进了POSIX兼容性，提供了更多开源软件包的移植（如Python、OpenSSL等）。
- **云连接**：集成了MQTT、AMQP等物联网协议，支持与AWS、Azure等云平台的连接。


## 参考资料

1. Wind River Systems, *VxWorks Programmer's Guide*.
2. Wind River Systems, *VxWorks 7 Product Overview*.
3. Glenn Reeves, "What Really Happened on Mars," JPL, 1997.
4. [Wind River VxWorks官方网站](https://www.windriver.com/products/vxworks)
